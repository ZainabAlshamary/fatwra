<div class="main-sidebar main-sidebar-sticky side-menu">
	<div class="sidemenu-logo">
		<a class="main-logo" href="#">
			<img src="../assets/img/brand/logo.png" class="header-brand-img desktop-logo" style="width:111px" alt="logo">
			<img src="../assets/img/brand/icon.png" class="header-brand-img icon-logo" alt="logo">
			<img src="../assets/img/brand/icon.png" class="header-brand-img desktop-logo theme-logo" alt="logo">
			<img src="../assets/img/brand/icon.png" class="header-brand-img icon-logo theme-logo" alt="logo">
		</a>
	</div>
	<div class="main-sidebar-body">
		<ul class="nav" id="provider" style="display:none">
			<li class="nav-header"><span class="nav-label">القوائم</span></li>
			<li class="nav-item">
				<a class="nav-link" href="index"><span class="shape1"></span><span class="shape2"></span><i class="ti-home sidemenu-icon"></i><span class="sidemenu-label">الرئيسية</span></a>
			</li>
			<li class="nav-item">
				<a class="nav-link with-sub" href="#"><span class="shape1"></span><span class="shape2"></span><i class="ti-wallet sidemenu-icon"></i><span class="sidemenu-label">الفواتير</span><i class="angle fe fe-chevron-left"></i></a>
				<ul class="nav-sub">
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="billlist">قائمة الفواتير</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportfilebills">تفاصيل الفواتير المرفوعة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="createbill">انشاء فاتورة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="addcsvfile">انشاء مجموعة فواتير</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="addcancelfile">الغاء مجموعة فواتير</a>
					</li>

				</ul>
			</li>

			<li class="nav-item">
				<a class="nav-link with-sub" href="#"><span class="shape1"></span><span class="shape2"></span><i class="ti-wallet sidemenu-icon"></i><span class="sidemenu-label">التقارير</span><i class="angle fe fe-chevron-left"></i></a>
				<ul class="nav-sub">
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportallbills">الفواتير الكلية</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportpaidbills">الفواتير المدفوعة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportunpaidbills">الفواتير غير المدفوعة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportlatebills">الفواتير المتاخرة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportcancelbills">الفوانير الملغاة</a>
					</li>

				</ul>
			</li>


			<li class="nav-item">
				<a class="nav-link" href="addservice"><span class="shape1"></span><span class="shape2"></span><i class="ti-home sidemenu-icon"></i><span class="sidemenu-label">انشاء خدمة</span></a>
			</li>

		</ul>

		<ul class="nav" id="subprovider" style="display:none">
			<li class="nav-header"><span class="nav-label">القوائم</span></li>
			<li class="nav-item">
				<a class="nav-link" href="index"><span class="shape1"></span><span class="shape2"></span><i class="ti-home sidemenu-icon"></i><span class="sidemenu-label">الرئيسية</span></a>
			</li>
			<li class="nav-item">
				<a class="nav-link with-sub" href="#"><span class="shape1"></span><span class="shape2"></span><i class="ti-wallet sidemenu-icon"></i><span class="sidemenu-label">الفواتير</span><i class="angle fe fe-chevron-left"></i></a>
				<ul class="nav-sub">
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="billlist">قائمة الفواتير</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportfilebills">تفاصيل الفواتير المرفوعة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="createbill">انشاء فاتورة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="addcsvfile">انشاء مجموعة فواتير</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="addcancelfile">الغاء مجموعة فواتير</a>
					</li>

				</ul>
			</li>

			<li class="nav-item">
				<a class="nav-link with-sub" href="#"><span class="shape1"></span><span class="shape2"></span><i class="ti-wallet sidemenu-icon"></i><span class="sidemenu-label">التقارير</span><i class="angle fe fe-chevron-left"></i></a>
				<ul class="nav-sub">
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportallbills">الفواتير الكلية</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportpaidbills">الفواتير المدفوعة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportunpaidbills">الفواتير غير المدفوعة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportlatebills">الفواتير المتاخرة</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportcancelbills">الفوانير الملغاة</a>
					</li>

				</ul>
			</li>
		</ul>

	<ul class="nav" id="admin" style="display:none">
			<li class="nav-header"><span class="nav-label">القوائم</span></li>
			<li class="nav-item">
				<a class="nav-link" href="index"><span class="shape1"></span><span class="shape2"></span><i class="ti-home sidemenu-icon"></i><span class="sidemenu-label">الرئيسية</span></a>
			</li>
			<li class="nav-item">
				<a class="nav-link with-sub" href="#"><span class="shape1"></span><span class="shape2"></span><i class="ti-wallet sidemenu-icon"></i><span class="sidemenu-label">الادارة</span><i class="angle fe fe-chevron-left"></i></a>
				<ul class="nav-sub">
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="manageprovider">ادارة المزودين</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="managecustomer">ادارة الزبائن</a>
					</li>
					<!--
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="reportfilebills">ادارة التجار</a>
					</li>
					
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="addcsvfile">ادارة الحسابات</a>
					</li>
					<li class="nav-sub-item">
						<a class="nav-sub-link" href="addcancelfile">ادارة الدعم الفني</a>
					</li>
                   <li class="nav-sub-item">
						<a class="nav-sub-link" href="addcancelfile">ادارة المرقبين</a>
					</li>
					       <li class="nav-sub-item">
						<a class="nav-sub-link" href="addcancelfile">البحث</a>
					</li>--->
				</ul>
			</li>

		
		</ul>
		
	</div>
</div>

<div class="main-header side-header sticky">
	<div class="container-fluid">
		<div class="main-header-right">
			<a class="main-header-menu-icon" href="#" id="mainSidebarToggle"><span></span></a>
		</div>

		<div class="main-header-right">


			<div class="dropdown d-md-flex">
				<a class="nav-link icon full-screen-link" href="">
					<i class="fe fe-maximize fullscreen-button fullscreen header-icons"></i>
					<i class="fe fe-minimize fullscreen-button exit-fullscreen header-icons"></i>
				</a>
			</div>
			<div class="dropdown main-header-notification">
				<a class="nav-link icon">
					<i class="fe fe-bell header-icons"></i>
					<span class="badge badge-danger nav-link-badge CountNotifications">0</span>
				</a>
				<div class="dropdown-menu">
					<div class="header-navheading">
						<p class="main-notification-text">الاشعارات<span class="badge badge-pill badge-primary mr-3">مشاهدة الكل</span></p>
					</div>
					<div class="main-notification-list Notificationlist">

					</div>
					<div class="dropdown-footer">
						<a href="billlist">عرض الكل</a>
					</div>
				</div>
			</div>
			<div class="dropdown main-profile-menu">
				<a class="d-flex" href="">
					<span class="main-img-user userimage"></span>
				</a>
				<div class="dropdown-menu">
					<div class="header-navheading">
						<h6 class="main-notification-title username"></h6>
					</div>
					<a class="dropdown-item border-top" href="profilesetting">
						<i class="fe fe-user"></i> حسابي
					</a>

					<a class="dropdown-item" onclick="Logout()" style="cursor: pointer;">
						<i class="fe fe-power"></i> تسجيل خروج
					</a>
				</div>
			</div>

			<button class="navbar-toggler navresponsive-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent-4" aria-controls="navbarSupportedContent-4" aria-expanded="false" aria-label="Toggle navigation">
				<i class="fe fe-more-vertical header-icons navbar-toggler-icon"></i>
			</button><!-- Navresponsive closed -->
		</div>
	</div>
</div>
<!-- End Main Header-->

<!-- Mobile-header -->
<div class="mobile-main-header">
	<div class="mb-1 navbar navbar-expand-lg  nav nav-item  navbar-nav-right responsive-navbar navbar-dark  ">
		<div class="collapse navbar-collapse" id="navbarSupportedContent-4">
			<div class="d-flex order-lg-2 mr-auto">


				<div class="dropdown ">
					<a class="nav-link icon full-screen-link">
						<i class="fe fe-maximize fullscreen-button fullscreen header-icons"></i>
						<i class="fe fe-minimize fullscreen-button exit-fullscreen header-icons"></i>
					</a>
				</div>
				<div class="dropdown main-header-notification">
					<a class="nav-link icon">
						<i class="fe fe-bell header-icons"></i>
						<span class="badge badge-danger nav-link-badge CountNotifications">0</span>
					</a>
					<div class="dropdown-menu">
						<div class="header-navheading">
							<p class="main-notification-text">الاشعارات<span class="badge badge-pill badge-primary mr-3">مشاهدة الكل</span></p>
						</div>
						<div class="main-notification-list Notificationlist">

						</div>
						<div class="dropdown-footer">
							<a href="#">عرض الكل</a>
						</div>
					</div>
				</div>

				<div class="dropdown main-profile-menu">
					<a class="d-flex" href="#">
						<span class="main-img-user userimage"></span>
					</a>
					<div class="dropdown-menu">
						<div class="header-navheading">
							<h6 class="main-notification-title username"></h6>
						</div>
						<a class="dropdown-item border-top" href="profilesetting">
							<i class="fe fe-user"></i> حسابي
						</a>

						<a class="dropdown-item border-top" onclick="Logout()" style="cursor: pointer;">
							<i class="fe fe-power" style="cursor: pointer;" ></i> تسجيل خروج
						</a>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>

<script>

  if (sessionStorage.getItem('token')) {} else {
      window.location.href = "../signin";
  }
  
	function Logout() {
		sessionStorage.clear();
		window.location.href = "../signin";
	}

	let role = sessionStorage.getItem('role');

	if (role == "Provider") {

		$("#provider").css({
			'display': 'block'
		});

		GetInformation();

		function GetInformation() {

			$.ajax({
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "Provider/GetProviderInformation?providerId=" + providerId + "",
				"method": "GET",
				"headers": {
					"Authorization": Token
				},
			}).done(function(response) {

				$(".userimage").html(`<img alt='avatar' src='`+ API +`` + response.data.imagePath + `'>`);
				$(".username").html(`<h6 class="main-notification-title">` + response.data.name + `</h6>`);
			});
		}


		var CountNotificationsstore = 0;
		GetNotifications();

		function GetNotifications() {

			$.ajax({
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "Provider/GetNotifications?start=0&end=20",
				"method": "GET",
				"headers": {
					"Content-Type": "application/json",
					"Authorization": Token
				},
			}).done(function(response) {
				$("#notificationsLoader").hide();
				$("#notificationsBadge").hide();

				CountNotificationsstore = response.data.count;

				$(".CountNotifications").html(`<span>` + response.data.count + `<span>`);
				var Notificationshtml = "",
					j = 1;

				for (var i = 0; i < response.data.bills.length; i++) {

					Notificationshtml += `<div class="media">
																				<div class="main-img-user online"><img alt="avatar" src="../assets/img/bill.png"></div>
																				<div class="media-body">
																					<p><strong> تم دفع فاتورة </strong>` + response.data.bills[i].customerName + `</p><span>رقم الفاتورة ` + response.data.bills[i].payId + `</span>
																				</div>
																			</div>`;
				}
				$(".Notificationlist").html(Notificationshtml);


			});
		}

		function ReadallNotification() {

			var settings = {
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "Provider/SetNotificationsRead",
				"method": "POST",
				"headers": {
					"Authorization": Token
				},
				"processData": false,
				"data": ""
			}

			$.ajax(settings).done(function(response) {});
		}


		const connection = new signalR.HubConnectionBuilder()
			.withUrl(API+ "/Hubs/Notification")
			.build();
		try {
			connection.start().then(function() {
				console.log("connected");
				//add to connected provider;
				connection.invoke("AddProvider", providerId).catch(err => console.error(err));
			});
		} catch (err) {
			console.log(err);
		}

		connection.on("CheckConnection", (msg) => {
			console.log(msg)
		});

		connection.on("GetNotification", (bill) => {
			var CustomerName = bill["customerName"];
			var PayId = bill["payId"];
			toastr.success(`تم دفع فاتورة الزبون: ${CustomerName} <br/>رقم الفاتورة :${PayId}`, `منصة فاتورة`, options);
			new Audio('../assets/soft-bells.mp3').play();

			GetNotifications();

		});


	} // provider 


	if (role == "SubProvider") {

		$("#subprovider").css({
			'display': 'block'
		});

		GetInformation();

		function GetInformation() {

			$.ajax({
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "SubProvider/GetSupProviderInformation",
				"method": "GET",
				"headers": {
					"Authorization": Token
				},
			}).done(function(response) {

				$(".userimage").html(`<img alt='avatar' src='` + response.data.imagePath + `'>`);
				$(".username").html(`<h6 class="main-notification-title">` + response.data.name + `</h6>`);
			});
		}


		var CountNotificationsstore = 0;
		GetNotifications();

		function GetNotifications() {

			$.ajax({
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "SubProvider/GetNotifications?start=0&end=20",
				"method": "GET",
				"headers": {
					"Content-Type": "application/json",
					"Authorization": Token
				},
			}).done(function(response) {
				$("#notificationsLoader").hide();
				$("#notificationsBadge").hide();

				CountNotificationsstore = response.data.count;

				$(".CountNotifications").html(`<span>` + response.data.count + `<span>`);
				var Notificationshtml = "",
					j = 1;

				for (var i = 0; i < response.data.bills.length; i++) {

					Notificationshtml += `<div class="media">
																		<div class="main-img-user online"><img alt="avatar" src="../assets/img/bill.png"></div>
																		<div class="media-body">
																			<p><strong> تم دفع فاتورة </strong>` + response.data.bills[i].customerName + `</p><span>رقم الفاتورة ` + response.data.bills[i].payId + `</span>
																		</div>
																	</div>`;
				}
				$(".Notificationlist").html(Notificationshtml);


			});
		}

		function ReadallNotification() {

			var settings = {
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "SubProvider/SetNotificationsRead",
				"method": "POST",
				"headers": {
					"Authorization": Token
				},
				"processData": false,
				"data": ""
			}

			$.ajax(settings).done(function(response) {});
		}


		const connection = new signalR.HubConnectionBuilder()
			.withUrl(API+ "/Hubs/Notification")
			.build();
		try {
			connection.start().then(function() {
				console.log("connected");
				//add to connected provider;
				connection.invoke("AddProvider", providerId).catch(err => console.error(err));
			});
		} catch (err) {
			console.log(err);
		}

		connection.on("CheckConnection", (msg) => {
			console.log(msg)
		});

		connection.on("GetNotification", (bill) => {
			var CustomerName = bill["customerName"];
			var PayId = bill["payId"];
			toastr.success(`تم دفع فاتورة الزبون: ${CustomerName} <br/>رقم الفاتورة :${PayId}`, `منصة فاتورة`, options);
			new Audio('../assets/soft-bells.mp3').play();

			GetNotifications();

		});


	} // subprovider
	
	if (role == "Admin") {

		$("#admin").css({
			'display': 'block'
		});

		GetInformation();

		function GetInformation() {

			$.ajax({
				"async": true,
				"crossDomain": true,
				"url": DomainAPI + "Admin/GetAdminInformation?providerId=bc7ba8ec-fd44-4b48-a5e1-c7964d437ad8",
				"method": "GET",
				"headers": {
					"Authorization": Token
				},
			}).done(function(response) {

				$(".userimage").html(`<img alt='avatar' src='` + response.data.imagePath + `'>`);
				$(".username").html(`<h6 class="main-notification-title">` + response.data.name + `</h6>`);
			});
		}


		


	} // ِAdmin
</script>